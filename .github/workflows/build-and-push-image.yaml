 # This GitHub action is for publishing the primary image for AnythingLLM to a private registry.
 
# It will publish a linux/amd64 and linux/arm64 image at the same time.

# This file should ONLY BY USED FOR `master` BRANCH.

#

# REQUIRED SECRETS:

# - PRIVATE_REGISTRY_URL: The URL of your private Docker registry (e.g., myregistry.example.com)

# - PRIVATE_REGISTRY_USER: The username for authenticating with the private registry.

# - PRIVATE_REGISTRY_PASSWORD: The password or access token for the private registry user.



name: Publish AnythingLLM Primary Docker image to Private Registry (amd64/arm64)



concurrency:

  group: build-private-${{ github.ref }}
  
  cancel-in-progress: true
  


on:

  push:
  
    branches: ['master']
    
    # master branch only. Do not modify.
    
    paths-ignore:
    
      - '**.md'
      
      - '.gitmodules'
      
      - 'cloud-deployments/**/*'
      
      - 'images/**/*'
      
      - '.vscode/**/*'
      
      - '**/.env.example'
      
      - '.github/ISSUE_TEMPLATE/**/*'
      
      - '.devcontainer/**/*'
      
      - 'embed/**/*'  # Embed is submodule
      
      - 'browser-extension/**/*'  # Chrome extension is submodule
      
      - 'server/utils/agents/aibitat/example/**/*'  # Do not push new image for local dev testing of new aibitat images.
      
      - 'extras/**/*'  # Extra is just for news and other local content.
      


jobs:

  push_multi_platform_to_private_registry:
  
    name: Push Docker multi-platform image to a private registry
    
    runs-on: ubuntu-latest
    
    permissions:
    
      contents: read
      
    steps:
    
      - name: Check out the repo
      
        uses: actions/checkout@v4
        


      - name: Set up QEMU
      
        uses: docker/setup-qemu-action@v3
        


      - name: Set up Docker Buildx
      
        uses: docker/setup-buildx-action@v3
        
        with:
        
          version: v0.22.0
          


      - name: Log in to private registry
      
        uses: docker/login-action@v3
        
        with:
        
          registry: ${{ secrets.PRIVATE_REGISTRY_URL }}
          
          username: ${{ secrets.PRIVATE_REGISTRY_USER }}
          
          password: ${{ secrets.PRIVATE_REGISTRY_PASSWORD }}
          


      - name: Extract metadata (tags, labels) for Docker
      
        id: meta
        
        uses: docker/metadata-action@v5
        
        with:
        
          images: ${{ secrets.PRIVATE_REGISTRY_URL }}/${{ github.repository }}
          
          tags: |
          
            type=raw,value=latest,enable={{is_default_branch}}
            
            type=ref,event=branch
            
            type=ref,event=tag
            
            type=ref,event=pr
            


      - name: Build and push multi-platform Docker image
      
        uses: docker/build-push-action@v6
        
        with:
        
          context: .
          
          file: ./docker/Dockerfile
          
          push: true
          
          sbom: true
          
          provenance: mode=max
          
          platforms: linux/amd64,linux/arm64
          
          tags: ${{ steps.meta.outputs.tags }}
          
          labels: ${{ steps.meta.outputs.labels }}
          
          cache-from: type=gha
          
          cache-to: type=gha,mode=max




























































